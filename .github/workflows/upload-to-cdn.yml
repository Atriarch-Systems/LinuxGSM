name: Upload LinuxGSM Assets to CDN
# Uploads key LinuxGSM files to the Atriarch CDN for use by docker builds
# This prevents hitting GitHub raw URLs during container builds
#
# Uses OAuth2 Client Credentials flow:
# 1. Get access token from IdentityServer using CDN_CLIENT_ID and CDN_CLIENT_SECRET
# 2. Use access token to upload files to CDN API
#
# Required secrets:
# - CDN_TOKEN_ENDPOINT: https://ids.atriarch.systems/connect/token
# - CDN_CLIENT_ID: github-cdn-uploader
# - CDN_CLIENT_SECRET: (the client secret)
# - CDN_SCOPE: AtriarchCdn_Write

on:
  push:
    branches: [atriarch]
    paths:
      - 'linuxgsm.sh'
      - 'lgsm/data/**'
  workflow_dispatch:

jobs:
  upload-to-cdn:
    if: github.repository == 'Atriarch-Systems/LinuxGSM'
    runs-on: [self-hosted, Linux, X64, amd64, arc-amd64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: atriarch

      - name: Get OAuth2 Access Token
        id: get-token
        run: |
          # Get access token using client credentials flow
          TOKEN_RESPONSE=$(curl -s -X POST "${{ secrets.CDN_TOKEN_ENDPOINT }}" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "client_id=${{ secrets.CDN_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.CDN_CLIENT_SECRET }}" \
            -d "scope=${{ secrets.CDN_SCOPE }}")
          
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
          
          if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "Failed to get access token"
            echo "$TOKEN_RESPONSE"
            exit 1
          fi
          
          # Mask the token in logs
          echo "::add-mask::$ACCESS_TOKEN"
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
          echo "Successfully obtained access token"

      - name: Upload linuxgsm.sh to CDN
        run: |
          echo "Uploading linuxgsm.sh..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT "https://cdn.atriarch.systems/api/files/lgsm/linuxgsm.sh" \
            -H "Authorization: Bearer ${{ steps.get-token.outputs.access_token }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @linuxgsm.sh)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✓ linuxgsm.sh uploaded successfully"
          else
            echo "✗ Failed to upload linuxgsm.sh (HTTP $HTTP_CODE)"
            echo "$BODY"
          fi
        continue-on-error: true

      - name: Upload data CSV files to CDN
        run: |
          for file in lgsm/data/*.csv; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "Uploading $filename..."
              
              RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT "https://cdn.atriarch.systems/api/files/lgsm/data/$filename" \
                -H "Authorization: Bearer ${{ steps.get-token.outputs.access_token }}" \
                -H "Content-Type: text/csv" \
                --data-binary @"$file")
              
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              
              if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                echo "✓ $filename uploaded"
              else
                echo "✗ Failed to upload $filename (HTTP $HTTP_CODE)"
              fi
            fi
          done
        continue-on-error: true

      - name: Summary
        run: |
          echo "## CDN Upload Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following files have been uploaded to cdn.atriarch.systems:" >> $GITHUB_STEP_SUMMARY
          echo "- /lgsm/linuxgsm.sh" >> $GITHUB_STEP_SUMMARY
          echo "- /lgsm/data/*.csv (dependency lists)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If CDN upload failed, builds will fall back to Atriarch-Systems/LinuxGSM GitHub URLs." >> $GITHUB_STEP_SUMMARY
