name: Merge Master to Atriarch
# This workflow merges changes from master (synced from upstream) into the atriarch branch
# Run this manually when you want to uptake upstream changes

on:
  workflow_dispatch:
    inputs:
      merge_strategy:
        description: 'Merge strategy to use'
        required: true
        default: 'merge'
        type: choice
        options:
          - merge
          - rebase

jobs:
  merge-to-atriarch:
    if: github.repository == 'Atriarch-Systems/LinuxGSM'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout atriarch branch
        uses: actions/checkout@v4
        with:
          ref: atriarch
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch master
        run: git fetch origin master

      - name: Show incoming changes
        run: |
          echo "=== Commits to be merged ==="
          git log --oneline atriarch..origin/master | head -50
          echo ""
          echo "=== Files changed ==="
          git diff --stat atriarch..origin/master | tail -20

      - name: Merge master into atriarch
        if: ${{ inputs.merge_strategy == 'merge' }}
        run: |
          git merge origin/master --no-edit -m "chore: merge upstream changes from master"

      - name: Rebase atriarch onto master
        if: ${{ inputs.merge_strategy == 'rebase' }}
        run: |
          git rebase origin/master

      - name: Push changes
        run: |
          if [ "${{ inputs.merge_strategy }}" == "rebase" ]; then
            git push origin atriarch --force-with-lease
          else
            git push origin atriarch
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Merge Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Strategy: ${{ inputs.merge_strategy }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The atriarch branch has been updated with the latest upstream changes." >> $GITHUB_STEP_SUMMARY
